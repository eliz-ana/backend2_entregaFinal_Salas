ğŸ›’ Ecommerce API â€“ Express + Mongoose

Back-end con capas profesionales: Controllers â†’ Services â†’ Repositories â†’ DAOs â†’ Models.
Incluye autenticaciÃ³n JWT, roles (admin/user), carritos, compra con tickets y recupero de contraseÃ±a por email (token 1h).

ğŸš€ Requisitos

Node.js 18+
MongoDB Atlas
Cliente REST (Insomnia / Postman)

âš™ï¸ ConfiguraciÃ³n

Clonar e instalar:

git clone <URL_DEL_REPO>
cd <CARPETA>
npm install


Variables de entorno
CopiÃ¡ .env.example a .env y completÃ¡ valores:

PORT=8080
NODE_ENV=development

MONGO_URI=mongodb+srv://<USER>:<PASSWORD>@cluster0.zcaes0j.mongodb.net/class_zero?retryWrites=true&w=majority&appName=Cluster0

JWT_SECRET=<CLAVE_SECRETA>
JWT_EXPIRES_IN=1d

APP_BASE_URL=http://localhost:8080

# Mailtrap (Email Sandbox)
MAIL_HOST=sandbox.smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USER=<MAILTRAP_USER>
MAIL_PASS=<MAILTRAP_PASS>



Ejecutar

# modo dev
npm run dev

# producciÃ³n
npm start


Servidor: http://localhost:8080

ğŸ§± Arquitectura
src/
  config/        (passport, db)
  controllers/   (lÃ³gica HTTP)
  services/      (lÃ³gica de negocio: purchase, password reset, mail)
  repositories/  (patrÃ³n Repository)
  dao/           (acceso a datos)
  models/        (Mongoose)
  middlewares/   (auth/roles/validaciones)
  routes/        (routers)

ğŸ” AutenticaciÃ³n & AutorizaciÃ³n

JWT vÃ­a passport-jwt (estrategia current) con cookie authToken o Bearer.

Roles:

admin: puede crear/editar/eliminar products.
user: puede operar su cart y comprar.

/api/sessions/current devuelve un DTO sin datos sensibles.

ğŸ§ª Insomnia

Se incluye colecciÃ³n en insomnia_test.
Flujo tÃ­pico:

Registrar o login â†’ copiar token
Probar endpoints protegidos usando Bearer o la cookie authToken.

# Importante se comparten credenciales SMTP para Mailtrap por privado

### CÃ³mo probar reset de contraseÃ±a
ğŸ“Œ Endpoints
Sessions

1) POST /api/sessions/forgot  { "email": "<usuario_existente>" }
2) Revisar Mailtrap (Sandbox) y abrir el mail â†’ copiar `token` del botÃ³n.
3) POST /api/sessions/reset  { "email": "<mismo_email>", "token": "<TOKEN>", "newPassword": "NuevaPass!123" }
4) Volver a loguear con la nueva contraseÃ±a (la anterior debe fallar).
5) Reintentar el mismo token â†’ 401 (token usado/expirado en 1h).


body: { "email": "..." } â†’ responde 200 siempre

POST /api/sessions/reset â€“ aplica nueva contraseÃ±a (no permite repetir)

body: { "email": "...", "token": "...", "newPassword": "..." }

Users (ejemplos)

GET /api/users â€“ listar (sin password)
GET /api/users/:uid â€“ detalle (sin password)
POST /api/users â€“ crear
PUT /api/users/:uid â€“ actualizar (normaliza email y re-hashea si cambia pass)
DELETE /api/users/:uid â€“ eliminar

Internamente: Repository + DAO con proyecciÃ³n -password donde corresponde.

Products

GET /api/products â€“ pÃºblico
GET /api/products/:pid â€“ pÃºblico
POST /api/products â€“ admin
PUT /api/products/:pid â€“ admin
DELETE /api/products/:pid â€“ admin

Carts

POST /api/carts â€“ user (crea carrito para el user actual)
GET /api/carts/:cid?populated=true â€“ user
POST /api/carts/:cid/product/:pid â€“ user (agrega/incrementa)
PUT /api/carts/:cid/product/:pid â€“ user (setea quantity)
DELETE /api/carts/:cid/product/:pid â€“ user (remueve item)
DELETE /api/carts/:cid â€“ user (vacÃ­a)

POST /api/carts/:cid/purchase â€“ user
Procesa compra: descuenta stock donde alcanza, genera Ticket y deja en el carrito los pendientes. Respuesta:

{ "ticket": { "code": "...", "amount": 1234, "purchaser": "email" }, "unprocessedProducts": ["<pid>", ...] }

ğŸ« Ticket

Modelo tickets: { code, purchase_datetime, amount, purchaser }.
Se crea en /purchase si hubo productos con stock suficiente.

âœ‰ï¸ RecuperaciÃ³n de contraseÃ±a (detalle)

/forgot genera token aleatorio, guarda hash SHA-256 + expiresAt=now+1h, y envÃ­a email (Mailtrap Sandbox).
/reset valida token (hash y vencimiento), evita repetir la contraseÃ±a actual, actualiza el hash y marca el token como usado.

âœ… Criterios de la entrega (cumplidos)

DAO + DTO en persistencia (password no expuesta).

PatrÃ³n Repository separando negocio y datos.

Middleware de autorizaciÃ³n por rol + estrategia current.

Modelo Ticket + lÃ³gica de compra (stock, tickets, compras parciales).

Arquitectura profesional y variables de entorno.

Recupero de contraseÃ±a con mail, expiraciÃ³n 1h y â€œno repetirâ€.

ğŸ©º Healthcheck

GET /health (si estÃ¡ en el repo) para verificar que el server estÃ¡ arriba.